-- ============================================
-- Database Optimization - Add Indexes
-- LAS Trivon Patient Management System
-- Date: January 6, 2026
-- ============================================

USE patient_management;

-- ============================================
-- APPOINTMENTS TABLE INDEXES
-- ============================================

-- Check if index exists before creating
DROP INDEX IF EXISTS idx_appointments_doctor ON appointments;
DROP INDEX IF EXISTS idx_appointments_patient ON appointments;
DROP INDEX IF EXISTS idx_appointments_date ON appointments;
DROP INDEX IF EXISTS idx_appointments_status ON appointments;
DROP INDEX IF EXISTS idx_appointments_clinic ON appointments;

-- Add indexes for faster queries
CREATE INDEX idx_appointments_doctor ON appointments(doctor_id);
CREATE INDEX idx_appointments_patient ON appointments(patient_id);
CREATE INDEX idx_appointments_date ON appointments(appointment_date);
CREATE INDEX idx_appointments_status ON appointments(status);
CREATE INDEX idx_appointments_clinic ON appointments(clinic_id);

-- Composite index for common queries
CREATE INDEX idx_appointments_doctor_date ON appointments(doctor_id, appointment_date);
CREATE INDEX idx_appointments_status_date ON appointments(status, appointment_date);

-- ============================================
-- PRESCRIPTIONS TABLE INDEXES
-- ============================================

DROP INDEX IF EXISTS idx_prescriptions_patient ON prescriptions;
DROP INDEX IF EXISTS idx_prescriptions_doctor ON prescriptions;
DROP INDEX IF EXISTS idx_prescriptions_date ON prescriptions;
DROP INDEX IF EXISTS idx_prescriptions_appointment ON prescriptions;

CREATE INDEX idx_prescriptions_patient ON prescriptions(patient_id);
CREATE INDEX idx_prescriptions_doctor ON prescriptions(doctor_id);
CREATE INDEX idx_prescriptions_date ON prescriptions(created_at);
CREATE INDEX idx_prescriptions_appointment ON prescriptions(appointment_id);

-- ============================================
-- BILLS TABLE INDEXES
-- ============================================

DROP INDEX IF EXISTS idx_bills_patient ON bills;
DROP INDEX IF EXISTS idx_bills_status ON bills;
DROP INDEX IF EXISTS idx_bills_date ON bills;
DROP INDEX IF EXISTS idx_bills_clinic ON bills;

CREATE INDEX idx_bills_patient ON bills(patient_id);
CREATE INDEX idx_bills_status ON bills(payment_status);
CREATE INDEX idx_bills_date ON bills(created_at);
CREATE INDEX idx_bills_clinic ON bills(clinic_id);

-- Composite index for financial reports
CREATE INDEX idx_bills_status_date ON bills(payment_status, created_at);
CREATE INDEX idx_bills_clinic_date ON bills(clinic_id, created_at);

-- ============================================
-- PATIENTS TABLE INDEXES
-- ============================================

DROP INDEX IF EXISTS idx_patients_phone ON patients;
DROP INDEX IF EXISTS idx_patients_email ON patients;
DROP INDEX IF EXISTS idx_patients_name ON patients;
DROP INDEX IF EXISTS idx_patients_clinic ON patients;

CREATE INDEX idx_patients_phone ON patients(phone);
CREATE INDEX idx_patients_email ON patients(email);
CREATE INDEX idx_patients_name ON patients(name);
CREATE INDEX idx_patients_clinic ON patients(clinic_id);

-- Full-text search index for patient search
ALTER TABLE patients ADD FULLTEXT idx_patients_search (name, phone, email);

-- ============================================
-- USERS TABLE INDEXES
-- ============================================

DROP INDEX IF EXISTS idx_users_email ON users;
DROP INDEX IF EXISTS idx_users_role ON users;
DROP INDEX IF EXISTS idx_users_active ON users;

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_active ON users(is_active);

-- Composite index for authentication
CREATE INDEX idx_users_email_active ON users(email, is_active);

-- ============================================
-- DOCTORS TABLE INDEXES
-- ============================================

DROP INDEX IF EXISTS idx_doctors_user ON doctors;
DROP INDEX IF EXISTS idx_doctors_clinic ON doctors;
DROP INDEX IF EXISTS idx_doctors_status ON doctors;

CREATE INDEX idx_doctors_user ON doctors(user_id);
CREATE INDEX idx_doctors_clinic ON doctors(clinic_id);
CREATE INDEX idx_doctors_status ON doctors(status);

-- ============================================
-- STAFF TABLE INDEXES
-- ============================================

DROP INDEX IF EXISTS idx_staff_user ON staff;
DROP INDEX IF EXISTS idx_staff_clinic ON staff;
DROP INDEX IF EXISTS idx_staff_doctor ON staff;

CREATE INDEX idx_staff_user ON staff(user_id);
CREATE INDEX idx_staff_clinic ON staff(clinic_id);
CREATE INDEX idx_staff_doctor ON staff(doctor_id);

-- ============================================
-- CLINICS TABLE INDEXES
-- ============================================

DROP INDEX IF EXISTS idx_clinics_active ON clinics;
DROP INDEX IF EXISTS idx_clinics_name ON clinics;

CREATE INDEX idx_clinics_active ON clinics(is_active);
CREATE INDEX idx_clinics_name ON clinics(name);

-- ============================================
-- LAB TESTS TABLE INDEXES
-- ============================================

DROP INDEX IF EXISTS idx_lab_patient ON lab_tests;
DROP INDEX IF EXISTS idx_lab_appointment ON lab_tests;
DROP INDEX IF EXISTS idx_lab_date ON lab_tests;

CREATE INDEX idx_lab_patient ON lab_tests(patient_id);
CREATE INDEX idx_lab_appointment ON lab_tests(appointment_id);
CREATE INDEX idx_lab_date ON lab_tests(test_date);

-- ============================================
-- AUDIT LOGS TABLE INDEXES
-- ============================================

DROP INDEX IF EXISTS idx_audit_user ON audit_logs;
DROP INDEX IF EXISTS idx_audit_action ON audit_logs;
DROP INDEX IF EXISTS idx_audit_date ON audit_logs;
DROP INDEX IF EXISTS idx_audit_entity ON audit_logs;

CREATE INDEX idx_audit_user ON audit_logs(user_id);
CREATE INDEX idx_audit_action ON audit_logs(action);
CREATE INDEX idx_audit_date ON audit_logs(created_at);
CREATE INDEX idx_audit_entity ON audit_logs(entity_type, entity_id);

-- ============================================
-- NOTIFICATIONS TABLE INDEXES
-- ============================================

DROP INDEX IF EXISTS idx_notif_user ON notifications;
DROP INDEX IF EXISTS idx_notif_read ON notifications;
DROP INDEX IF EXISTS idx_notif_date ON notifications;

CREATE INDEX idx_notif_user ON notifications(user_id);
CREATE INDEX idx_notif_read ON notifications(is_read);
CREATE INDEX idx_notif_date ON notifications(created_at);

-- Composite index for unread notifications
CREATE INDEX idx_notif_user_unread ON notifications(user_id, is_read);

-- ============================================
-- VERIFICATION
-- ============================================

-- Show all indexes created
SELECT
    TABLE_NAME,
    INDEX_NAME,
    SEQ_IN_INDEX,
    COLUMN_NAME,
    INDEX_TYPE
FROM
    information_schema.STATISTICS
WHERE
    TABLE_SCHEMA = 'patient_management'
    AND INDEX_NAME LIKE 'idx_%'
ORDER BY
    TABLE_NAME, INDEX_NAME, SEQ_IN_INDEX;

-- ============================================
-- PERFORMANCE TESTING QUERIES
-- ============================================

-- Test appointment query performance
EXPLAIN SELECT a.*, p.name as patient_name
FROM appointments a
LEFT JOIN patients p ON a.patient_id = p.id
WHERE a.doctor_id = 1
AND a.appointment_date >= CURDATE();

-- Test patient search performance
EXPLAIN SELECT * FROM patients
WHERE phone LIKE '%1234%'
OR email LIKE '%test%';

-- Test bill query performance
EXPLAIN SELECT * FROM bills
WHERE payment_status = 'pending'
AND created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY);

-- ============================================
-- NOTES
-- ============================================

-- Performance Tips:
-- 1. Run ANALYZE TABLE periodically to update index statistics
-- 2. Use EXPLAIN to check if indexes are being used
-- 3. Monitor slow queries with slow query log
-- 4. Consider partitioning for very large tables
-- 5. Regular maintenance with OPTIMIZE TABLE

-- To analyze tables:
-- ANALYZE TABLE appointments, patients, bills, prescriptions;

-- To optimize tables:
-- OPTIMIZE TABLE appointments, patients, bills, prescriptions;

-- ============================================
-- SUCCESS MESSAGE
-- ============================================

SELECT 'Database indexes added successfully! Run EXPLAIN on your queries to verify index usage.' AS message;
